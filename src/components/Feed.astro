---
import { Image } from 'astro:assets';

interface MastodonPost {
  id: string;
  created_at: string;
  account: {
    display_name: string;
    username: string;
    avatar: string;
    acct: string;
  };
  content: string;
  media_attachments: {
    type: string;
    url: string;
    preview_url: string;
  }[];
  favourites_count: number;
  reblogs_count: number;
}

const accessToken = '4Q8cmSCWNhl_X5t5zcnAWp9EMxOYL7sNARH9jCb2GLM';
const apiUrl = 'https://thamizhi.xyz/api/v1/timelines/public?local=true';

let posts: MastodonPost[] = [];
let error: string | null = null;

try {
  const response = await fetch(apiUrl, {
    headers: {
      Authorization: `Bearer ${accessToken}`,
    },
  });

  if (!response.ok) {
    throw new Error(`HTTP error! status: ${response.status}`);
  }

  posts = await response.json();
  posts = posts.filter(post => !post.account.acct.includes('@') || post.account.acct.endsWith('@thamizhi.xyz'));
} catch (e) {
  console.error('Error fetching posts:', e);
  error = 'Failed to load posts. Please try again later.';
}
---

<section id="feed" class="max-w-xl mx-auto">
  {error && <p class="text-red-500 text-center py-4">{error}</p>}
  <div class="space-y-8">
    {posts.map((post) => (
      <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
        <div class="flex items-center p-4">
          <img
            src={post.account.avatar}
            alt={post.account.display_name}
            width="32"
            height="32"
            class="rounded-full mr-3"
          />
          <div>
            <p class="font-semibold text-sm">{post.account.display_name}</p>
            <p class="text-xs text-gray-500">@{post.account.username}</p>
          </div>
        </div>
        {post.media_attachments.length > 0 && (
          <div class="relative pb-[100%]">
            <img
              src={post.media_attachments[0].url}
              alt="Post media"
              class="absolute top-0 left-0 w-full h-full object-cover"
            />
          </div>
        )}
        <div class="p-4">
          <div class="flex space-x-4 mb-2">
            <button class="text-2xl">‚ù§Ô∏è</button>
            <button class="text-2xl">üí¨</button>
            <button class="text-2xl">üîÅ</button>
          </div>
          <p class="text-sm font-semibold mb-1">{post.favourites_count} likes</p>
          <div class="text-sm">
            <span class="font-semibold">{post.account.display_name}</span>
            <span set:html={post.content} />
          </div>
          <p class="text-xs text-gray-500 mt-2">{new Date(post.created_at).toLocaleString()}</p>
        </div>
      </div>
    ))}
  </div>
</section>

<style>
  /* Add any additional styles here */
  :global(.toot-content a) {
    color: #3b82f6;
    text-decoration: none;
  }
  :global(.toot-content a:hover) {
    text-decoration: underline;
  }
</style>